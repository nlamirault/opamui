# SPDX-FileCopyrightText: Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
# SPDX-License-Identifier: Apache-2.0

---
name: Build / OCaml

on:
  pull_request:
    paths:
    - dune-project
    - opamui.opam
    - bin/**/*.ml
    - lib/**/*.ml
    - test/**/*.ml
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os:
        - ubuntu-latest
        - macos-latest
        # - windows-latest

    runs-on: ${{ matrix.os }}

    name: Build on ${{ matrix.os }}

    steps:
    - name: ðŸšš Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0

    - name: ðŸŽ‰ Set-up OCaml
      uses: ocaml/setup-ocaml@dec6499fef64fc5d7ed43d43a87251b7b1c306f5 # v3.4.8
      with:
        ocaml-compiler: 5.2.x

    - name: ðŸŽ‰ Install dependencies
      run: opam install . --deps-only --with-test

    - name: âœ… Build application
      run: opam exec -- dune build

    - name: âœ… Execute tests
      run: opam exec -- dune runtest

    - name: Attest build provenance
      uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
      with:
        subject-path: _build/default/world.exe

    - name: Upload the build artifact
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: ${{ matrix.os }}-${{ matrix.ocaml-compiler }}-opamui
        path: _build/default/opamui.exe

  lint-doc:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸšš Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0

    - name: ðŸŽ‰ Set-up OCaml
      uses: ocaml/setup-ocaml@dec6499fef64fc5d7ed43d43a87251b7b1c306f5 # v3.4.8
      with:
        ocaml-compiler: 5.2.x

    - name: âœ… Lint documentation
      uses: ocaml/setup-ocaml/lint-doc@dec6499fef64fc5d7ed43d43a87251b7b1c306f5 # v3.4.8

  lint-fmt:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸšš Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0

    - name: ðŸŽ‰ Set-up OCaml
      uses: ocaml/setup-ocaml@dec6499fef64fc5d7ed43d43a87251b7b1c306f5 # v3.4.8
      with:
        ocaml-compiler: 5.2.x

    - name: âœ… OCaml formatting
      uses: ocaml/setup-ocaml/lint-fmt@dec6499fef64fc5d7ed43d43a87251b7b1c306f5 # v3.4.8

  lint-opam:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸšš Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0

    - name: ðŸŽ‰ Set-up OCaml
      uses: ocaml/setup-ocaml@dec6499fef64fc5d7ed43d43a87251b7b1c306f5 # v3.4.8
      with:
        ocaml-compiler: 5.2.x

    - name: âœ… Lint OPam configuration
      uses: ocaml/setup-ocaml/lint-opam@dec6499fef64fc5d7ed43d43a87251b7b1c306f5 # v3.4.8
