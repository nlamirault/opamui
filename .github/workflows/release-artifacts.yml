# SPDX-FileCopyrightText: Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
# SPDX-License-Identifier: Apache-2.0

---
name: Release / Artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to build artifacts for"
        required: true

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    strategy:
      fail-fast: false # Don't cancel other jobs if one fails
      matrix:
        os:
        - ubuntu-latest
        - macos-latest
        # - windows-latest
    env:
      OPAM_DESTDIR: ${{ github.workspace }}/opam-destdir

    runs-on: ${{ matrix.os }}
    name: Release for ${{ matrix.os }}

    outputs:
      # hash: ${{ steps.hash.outputs.hash }}
      hash-ubuntu-latest: ${{ steps.hash.outputs.hash-ubuntu-latest }}
      hash-macos-latest: ${{ steps.hash.outputs.hash-macos-latest }}
      # hash-windows-latest: ${{ steps.hash.outputs.hash-windows-latest }}
      binary-name: ${{ steps.hash.outputs.binary-name }}
      artifact-name: ${{ steps.hash.outputs.artifact-name }}

    steps:
    - name: Set TAG_NAME variable
      run: |
        if [ -n "${{ github.event.inputs.tag }}" ]; then
          echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
        else
          echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
        fi

    - name: üöö Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        fetch-depth: 0

    - name: üéâ Set-up OCaml
      uses: ocaml/setup-ocaml@ddef532293b85980b315344506def8eb09917e2c # v3.4.6
      with:
        ocaml-compiler: 5.2.x

    - name: üì¶ Install dependencies
      run: opam install . --deps-only --with-test

    - name: ‚úÖ Build artifacts
      run: |
        mkdir -p "$OPAM_DESTDIR"
        opam install ./opamui.opam --destdir="$OPAM_DESTDIR"
      env:
        OPAMYES: "true"

    - name: ‚úÖ Prepare Artifacts
      id: hash
      run: |
        set -euo pipefail

        os=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
        arch=$(uname -m)
        bin_name="${{ github.workspace }}/opamui-$TAG_NAME-$os-$arch"
        artifact_name="opamui-$TAG_NAME-$os-$arch"
        cp "$OPAM_DESTDIR/bin/opamui" $bin_name

        echo "BIN_NAME=$bin_name" >> $GITHUB_ENV

        # Cross-platform hash calculation
        if [[ "${{ runner.os }}" == "macOS" ]]; then
          checksum=$(shasum -a 256 $bin_name | base64)
        else
          checksum=$(sha256sum $bin_name | base64 -w0)
        fi
        echo "hash-${{ matrix.os }}=$checksum" >> "${GITHUB_OUTPUT}"
        # echo "hash=$hash" >> "$GITHUB_OUTPUT"

        echo "binary-name=$bin_name" >> "$GITHUB_OUTPUT"
        echo "artifact-name=$artifact_name" >> "$GITHUB_OUTPUT"

    - name: üîì Attest Artifacts Provenance
      uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
      with:
        subject-path: "${{ steps.hash.outputs.binary-name }}"

    - name: ‚úÖ Generate SBOM
      uses: anchore/sbom-action@8e94d75ddd33f69f691467e42275782e4bfefe84 # v0.20.9
      id: sbom
      with:
        path: ${{ github.workspace }}
        format: spdx-json
        output-file: ${{ steps.hash.outputs.artifact-name }}.spdx.json
        upload-artifact: false

    - name: üîì Attest SBOM
      uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
      with:
        subject-path: "${{ steps.hash.outputs.binary-name }}"
        sbom-path: "${{ steps.hash.outputs.artifact-name }}.spdx.json"

    - name: ‚¨ÜÔ∏è Upload SBOM
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: ${{ steps.hash.outputs.artifact-name }}-sbom
        path: ${{ steps.hash.outputs.artifact-name }}.spdx.json
        retention-days: 90

    - name: ‚¨ÜÔ∏è Upload artifacts
      uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2.3.3
      with:
        tag_name: ${{ env.TAG_NAME }}
        files: |
          ${{ steps.hash.outputs.binary-name }}
          ${{ steps.hash.outputs.artifact-name }}.spdx.json
          ${{ steps.hash.outputs.artifact-name }}.intoto.jsonl

  provenance:
    needs:
    - release
    strategy:
      matrix:
        os:
        - ubuntu-latest
        - macos-latest
        # - windows-latest
    permissions:
      actions: read # To read the workflow path.
      id-token: write # To sign the provenance.
      contents: write # To add assets to a release.
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      # base64-subjects: "${{ needs.release.outputs.hash }}"
      base64-subjects: "${{ needs.release.outputs[format('hash-{0}', matrix.os)] }}"
      upload-assets: true # upload to a new release

  verification:
    needs:
    - release
    - provenance
    runs-on: ubuntu-latest
    permissions: read-all

    name: Verification

    steps:
    - name: üõ°Ô∏è Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
      with:
        egress-policy: audit

    - name: üéâ Install the SLSA verifier
      uses: slsa-framework/slsa-verifier/actions/installer@6657aada084353c65e5dde35394b1a010289fab0 # v2.7.0

    - name: ‚¨áÔ∏è Download assets
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail

        if [ -n "${{ github.event.inputs.tag }}" ]; then
          release_name="${{ github.event.inputs.tag }}"
        else
          release_name="${{ github.ref_name }}"
        fi

        echo "Download artifacts from ${GITHUB_REPOSITORY} for ${release_name}"
        gh -R "${GITHUB_REPOSITORY}" release download "${release_name}" -p "${{ needs.release.outputs.artifact-name }}*"
        gh -R "${GITHUB_REPOSITORY}" release download "${release_name}" -p "${{ needs.release.outputs.artifact-name }}.intoto.jsonl"
        ls

    - name: ‚úÖ Verify binary
      env:
        CHECKSUMS: ${{ needs.release.outputs.hash }}
      run: |
        set -euo pipefail

        slsa-verifier verify-artifact ${{ needs.release.outputs.artifact-name }} \
          --provenance-path ${{ needs.release.outputs.artifact-name }}.intoto.jsonl \
          --source-uri "github.com/${GITHUB_REPOSITORY}" \
          --source-tag "${GITHUB_REF_NAME}"
