# SPDX-FileCopyrightText: Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
# SPDX-License-Identifier: Apache-2.0

---
name: Release / Artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to build artifacts for"
        required: true

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    strategy:
      matrix:
        os:
        - ubuntu-latest
        - macos-latest
        # - windows-latest
    env:
      OPAM_DESTDIR: ${{ github.workspace }}/opam-destdir

    runs-on: ${{ matrix.os }}
    name: Release for ${{ matrix.os }}

    outputs:
      hash: ${{ steps.hash.outputs.hash }}
      binary-name: ${{ steps.hash.outputs.binary-name }}
      artifact-name: ${{ steps.hash.outputs.artifact-name }}

    steps:
    - name: Set TAG_NAME variable
      run: |
        if [ -n "${{ github.event.inputs.tag }}" ]; then
          echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
        else
          echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
        fi

    - name: üöö Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        fetch-depth: 0

    - name: üéâ Set-up OCaml
      uses: ocaml/setup-ocaml@ddef532293b85980b315344506def8eb09917e2c # v3.4.6
      with:
        ocaml-compiler: 5.2.x

    - name: üì¶ Install dependencies
      run: opam install . --deps-only --with-test

    - name: ‚úÖ Build artifacts
      run: |
        mkdir -p "$OPAM_DESTDIR"
        opam install ./opamui.opam --destdir="$OPAM_DESTDIR"
      env:
        OPAMYES: "true"

    - name: ‚úÖ Prepare Artifacts
      id: hash
      run: |
        os=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
        arch=$(uname -m)
        bin_name="${{ github.workspace }}/opamui-$TAG_NAME-$os-$arch"
        cp "$OPAM_DESTDIR/bin/opamui" $bin_name
        echo "BIN_NAME=$bin_name" >> $GITHUB_ENV

        # Cross-platform hash calculation
        if [[ "${{ runner.os }}" == "macOS" ]]; then
          hash=$(shasum -a 256 $bin_name | awk '{print $1}' | base64)
        else
          hash=$(sha256sum $bin_name | awk '{print $1}' | base64 -w0)
        fi

        echo "hash=$hash" >> "$GITHUB_OUTPUT"
        echo "binary-name=$bin_name" >> "$GITHUB_OUTPUT"
        echo "artifact-name=opamui-$TAG_NAME-$os-$arch" >> "$GITHUB_OUTPUT"

        ls -alFrt
        ls -alFrt $bin_name

    - name: üîì Attest Artifacts Provenance
      uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
      with:
        subject-path: "${{ steps.hash.outputs.binary-name }}"

    - name: ‚úÖ Generate SBOM
      uses: anchore/sbom-action@8e94d75ddd33f69f691467e42275782e4bfefe84 # v0.20.9
      with:
        format: "spdx-json"
        artifact-name: "${{ steps.hash.outputs.artifact-name }}.spdx.json"
        path: "${{ github.workspace }}"

    - name: üîì Attest SBOM
      uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
      with:
        subject-path: "${{ steps.hash.outputs.binary-name }}"
        sbom-path: "${{ steps.hash.outputs.artifact-name }}.spdx.json"

    - name: ‚¨ÜÔ∏è Publish SBOM
      uses: anchore/sbom-action/publish-sbom@v0
      with:
        sbom-artifact-match: ".*\\.spdx.json$"

    - name: ‚¨ÜÔ∏è Upload artifacts
      uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2.3.3
      with:
        tag_name: ${{ env.TAG_NAME }}
        files: |
          ${{ steps.hash.outputs.binary-name }}

  provenance:
    needs:
    - release
    permissions:
      actions: read # To read the workflow path.
      id-token: write # To sign the provenance.
      contents: write # To add assets to a release.
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.release.outputs.hash }}"
      upload-assets: true # upload to a new release

  verification:
    needs:
    - release
    - provenance
    runs-on: ubuntu-latest
    permissions: read-all

    name: Verification

    steps:
    - name: üõ°Ô∏è Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
      with:
        egress-policy: audit

    - name: üéâ Install the SLSA verifier
      uses: slsa-framework/slsa-verifier/actions/installer@6657aada084353c65e5dde35394b1a010289fab0 # v2.7.0

    - name: ‚¨áÔ∏è Download assets
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        echo "Download artifacts from ${GITHUB_REPOSITORY} for ${GITHUB_REF_NAME}"
        gh -R "${GITHUB_REPOSITORY}" release download "${GITHUB_REF_NAME}" -p "${{ needs.release.outputs.artifact-name }}*"
        gh -R "${GITHUB_REPOSITORY}" release download "${GITHUB_REF_NAME}" -p "${{ needs.release.outputs.artifact-name }}.intoto.jsonl"
        ls

    - name: ‚úÖ Verify binary
      env:
        CHECKSUMS: ${{ needs.release.outputs.hash }}
        PROVENANCE: "${{ needs.binary-provenance.outputs.provenance-name }}"
      run: |
        set -euo pipefail

        slsa-verifier verify-artifact ${{ needs.release.outputs.artifact-name }} \
          --provenance-path ${{ needs.release.outputs.artifact-name }}.intoto.jsonl \
          --source-uri "github.com/${GITHUB_REPOSITORY}" \
          --source-tag "${GITHUB_REF_NAME}"

    - name: ‚úÖ Verify build provenance
      run: |
        slsa-verifier verify-github-attestation xxxxxx \
          --source-uri github.com/aspect-build/rules_lint \
          --builder-id https://github.com/bazel-contrib/publish-to-bcr/.github/workflows/publish.yaml \
          --attestation-path MODULE.bazel.intoto.jsonl
